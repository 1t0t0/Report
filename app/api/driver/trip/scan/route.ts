// app/api/driver/trip/scan/route.ts - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ticket ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö
import { NextResponse } from 'next/server';
import connectDB from '@/lib/mongodb';
import DriverTrip from '@/models/DriverTrip';
import Ticket from '@/models/Ticket';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

// POST - ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡πã‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö duplicate ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö)
export async function POST(request: Request) {
  try {
    const session = await getServerSession(authOptions);
    if (!session || session.user.role !== 'driver') {
      return NextResponse.json(
        { error: 'Unauthorized - Only drivers can access this endpoint' },
        { status: 401 }
      );
    }

    await connectDB();
    
    const body = await request.json();
    const { ticketId, qrData } = body;
    
    console.log('Scan request:', { ticketId, qrData });
    
    let ticketNumber = ticketId;
    
    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö QR Code Data
    if (qrData) {
      try {
        // ‚ùå ‡πÄ‡∏î‡∏¥‡∏°: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON
        // const parsedQRData = JSON.parse(qrData);
        // if (parsedQRData.forDriverOnly && parsedQRData.ticketNumber) {
        //   ticketNumber = parsedQRData.ticketNumber;
        //   console.log('Using ticket number from QR:', ticketNumber);
        // }

        // ‚úÖ ‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ QR data ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡πã‡∏ß‡πÅ‡∏•‡πâ‡∏ß)
        if (typeof qrData === 'string' && qrData.trim()) {
          ticketNumber = qrData.trim();
          console.log('Using ticket number from QR:', ticketNumber);
        }
      } catch (error) {
        // ‚úÖ ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô string ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
        console.log('QR data is not JSON, using as plain string:', qrData);
        if (typeof qrData === 'string' && qrData.trim()) {
          ticketNumber = qrData.trim();
        }
      }
    }
    
    if (!ticketNumber || !ticketNumber.trim()) {
      return NextResponse.json(
        { error: '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªà‡∫õ‡∫µ‡ªâ' },
        { status: 400 }
      );
    }

    // ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    const driverId = session.user.id;
    const today = new Date().toISOString().split('T')[0];
    
    const activeTrip = await DriverTrip.findOne({
      driver_id: driverId,
      date: today,
      status: 'in_progress'
    });
    
    if (!activeTrip) {
      return NextResponse.json(
        { error: '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫Å‡∫≤‡∫ô‡ªÄ‡∫î‡∫µ‡∫ô‡∫ó‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô' },
        { status: 400 }
      );
    }
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ticket ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ticketNumber
    const ticket = await Ticket.findOne({ ticketNumber: ticketNumber.trim() });
    if (!ticket) {
      return NextResponse.json(
        { error: `‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫õ‡∫µ‡ªâ‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ ${ticketNumber}` },
        { status: 404 }
      );
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ticket ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const ticketUsedInSystem = await DriverTrip.findOne({
      'scanned_tickets.ticket_id': ticket._id
    });
    
    if (ticketUsedInSystem) {
      const usedByTrip = await DriverTrip.findOne({
        'scanned_tickets.ticket_id': ticket._id
      }).populate('driver_id', 'name employeeId');
      
      const scanDetails = usedByTrip?.scanned_tickets.find(
        (scan: any) => scan.ticket_id.toString() === ticket._id.toString()
      );
      
      const usedByDriverName = usedByTrip?.driver_id?.name || 'Unknown';
      const usedByEmployeeId = usedByTrip?.driver_id?.employeeId || 'Unknown';
      const scannedAt = scanDetails?.scanned_at ? new Date(scanDetails.scanned_at).toLocaleString('lo-LA') : 'Unknown';
      
      return NextResponse.json(
        { 
          error: `‚ùå ‡∫õ‡∫µ‡ªâ‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ ${ticketNumber} ‡∫ñ‡∫∑‡∫Å‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡ªÑ‡∫õ‡ªÅ‡∫•‡ªâ‡∫ß`,
          details: {
            message: `‡∫ñ‡∫∑‡∫Å‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡ªÇ‡∫î‡∫ç: ${usedByDriverName} (${usedByEmployeeId})`,
            scannedAt: `‡ªÄ‡∫ß‡∫•‡∫≤: ${scannedAt}`,
            tripId: usedByTrip?._id,
            usedByDriver: {
              name: usedByDriverName,
              employeeId: usedByEmployeeId
            }
          }
        },
        { status: 400 }
      );
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (activeTrip.current_passengers >= activeTrip.car_capacity) {
      return NextResponse.json(
        { error: `‡∫•‡∫ª‡∫î‡ªÄ‡∫ï‡∫±‡∫°‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫à‡∫∏‡∫™‡∫π‡∫á‡∫™‡∫∏‡∫î ${activeTrip.car_capacity} ‡∫Ñ‡∫ª‡∫ô` },
        { status: 400 }
      );
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£
    const passengerOrder = activeTrip.current_passengers + 1;
    
    activeTrip.scanned_tickets.push({
      ticket_id: ticket._id,
      scanned_at: new Date(),
      passenger_order: passengerOrder
    });
    
    activeTrip.current_passengers = passengerOrder;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó is_80_percent_reached
    const is80PercentReached = activeTrip.current_passengers >= activeTrip.required_passengers;
    activeTrip.is_80_percent_reached = is80PercentReached;
    
    await activeTrip.save();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    let message = `‚úÖ ‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î: ${activeTrip.current_passengers}/${activeTrip.car_capacity} ‡∫Ñ‡∫ª‡∫ô`;
    let statusMessage = '';
    
    if (is80PercentReached && activeTrip.current_passengers < activeTrip.car_capacity) {
      statusMessage = `üéØ ‡∫Ñ‡∫ª‡∫ö‡ªÄ‡∫õ‡∫ª‡ªâ‡∏≤‡ªù‡∫≤‡∫ç ${activeTrip.required_passengers} ‡∫Ñ‡∫ª‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫™‡∫∑‡∫ö‡∫ï‡ªç‡ªà‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫´‡∫º‡∫∑‡∫õ‡∫¥‡∫î‡∫Æ‡∫≠‡∫ö‡ªÑ‡∫î‡ªâ`;
    } else if (activeTrip.current_passengers === activeTrip.car_capacity) {
      statusMessage = `üöå ‡∫•‡∫ª‡∫î‡ªÄ‡∫ï‡∫±‡∫°‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡∫¥‡∫î‡∫Æ‡∫≠‡∫ö`;
    } else {
      const remaining = activeTrip.required_passengers - activeTrip.current_passengers;
      if (remaining > 0) {
        statusMessage = `‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫≠‡∫µ‡∫Å ${remaining} ‡∫Ñ‡∫ª‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡∫ö‡ªÄ‡∫õ‡∫ª‡ªâ‡∫≤‡ªù‡∫≤‡∫ç`;
      }
    }
    
    console.log('Trip updated successfully:', {
      tripId: activeTrip._id,
      currentPassengers: activeTrip.current_passengers,
      requiredPassengers: activeTrip.required_passengers,
      is80PercentReached: is80PercentReached,
      ticketScanned: ticket.ticketNumber
    });
    
    return NextResponse.json({
      success: true,
      trip_number: activeTrip.trip_number,
      current_passengers: activeTrip.current_passengers,
      required_passengers: activeTrip.required_passengers,
      car_capacity: activeTrip.car_capacity,
      occupancy_percentage: Math.round((activeTrip.current_passengers / activeTrip.car_capacity) * 100),
      progress_percentage: Math.round((activeTrip.current_passengers / activeTrip.required_passengers) * 100),
      is_80_percent_reached: is80PercentReached,
      can_complete_trip: true,
      trip_completed: false,
      message: message,
      status_message: statusMessage,
      ticket_info: {
        ticket_id: ticket._id,
        ticket_number: ticket.ticketNumber,
        price: ticket.price,
        passenger_order: passengerOrder
      }
    });

  } catch (error) {
    console.error('Scan QR Code Error:', error);
    return NextResponse.json(
      { 
        error: error instanceof Error ? error.message : 'Failed to scan QR code',
        details: error instanceof Error ? error.stack : 'Unknown error occurred'
      },
      { status: 500 }
    );
  }
}