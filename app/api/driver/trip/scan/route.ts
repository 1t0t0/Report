// app/api/driver/trip/scan/route.ts - Enhanced with Group Ticket Support
import { NextResponse } from 'next/server';
import connectDB from '@/lib/mongodb';
import DriverTrip from '@/models/DriverTrip';
import Ticket from '@/models/Ticket';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

// POST - ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡πã‡∏ß (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Group Ticket)
export async function POST(request: Request) {
  try {
    const session = await getServerSession(authOptions);
    if (!session || session.user.role !== 'driver') {
      return NextResponse.json(
        { error: 'Unauthorized - Only drivers can access this endpoint' },
        { status: 401 }
      );
    }

    await connectDB();
    
    const body = await request.json();
    const { ticketId, qrData } = body;
    
    console.log('Scan request:', { ticketId, qrData });
    
    let ticketNumber = ticketId;
    let groupTicketData = null;
    
    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö QR Code Data ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Group Ticket
    if (qrData) {
      try {
        // ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏Ç‡∏≠‡∏á Group Ticket ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const parsedQRData = JSON.parse(qrData);
        
        if (parsedQRData.ticketType === 'group' && parsedQRData.ticketNumber) {
          // ‡πÄ‡∏õ‡πá‡∏ô Group Ticket QR Code
          ticketNumber = parsedQRData.ticketNumber;
          groupTicketData = parsedQRData;
          console.log('‚úÖ Group Ticket QR detected:', {
            ticketNumber,
            passengerCount: parsedQRData.passengerCount,
            totalPrice: parsedQRData.totalPrice
          });
        } else if (parsedQRData.ticketNumber) {
          // ‡πÄ‡∏õ‡πá‡∏ô Individual Ticket QR Code ‡πÅ‡∏ö‡∏ö JSON
          ticketNumber = parsedQRData.ticketNumber;
          console.log('‚úÖ Individual Ticket QR (JSON) detected:', ticketNumber);
        }
      } catch (error) {
        // ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô string ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (Individual Ticket)
        console.log('QR data is plain string (Individual Ticket):', qrData);
        if (typeof qrData === 'string' && qrData.trim()) {
          ticketNumber = qrData.trim();
        }
      }
    }
    
    if (!ticketNumber || !ticketNumber.trim()) {
      return NextResponse.json(
        { error: '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªà‡∫õ‡∫µ‡ªâ' },
        { status: 400 }
      );
    }

    const driverId = session.user.id;
    const today = new Date().toISOString().split('T')[0];
    
    const activeTrip = await DriverTrip.findOne({
      driver_id: driverId,
      date: today,
      status: 'in_progress'
    });
    
    if (!activeTrip) {
      return NextResponse.json(
        { error: '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫Å‡∫≤‡∫ô‡ªÄ‡∫î‡∫µ‡∫ô‡∫ó‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô' },
        { status: 400 }
      );
    }
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ticket ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ticketNumber
    const ticket = await Ticket.findOne({ ticketNumber: ticketNumber.trim() });
    if (!ticket) {
      return NextResponse.json(
        { error: `‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫õ‡∫µ‡ªâ‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ ${ticketNumber}` },
        { status: 404 }
      );
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ticket ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const ticketUsedInSystem = await DriverTrip.findOne({
      'scanned_tickets.ticket_id': ticket._id
    });
    
    if (ticketUsedInSystem) {
      const usedByTrip = await DriverTrip.findOne({
        'scanned_tickets.ticket_id': ticket._id
      }).populate('driver_id', 'name employeeId');
      
      const scanDetails = usedByTrip?.scanned_tickets.find(
        (scan: any) => scan.ticket_id.toString() === ticket._id.toString()
      );
      
      const usedByDriverName = usedByTrip?.driver_id?.name || 'Unknown';
      const usedByEmployeeId = usedByTrip?.driver_id?.employeeId || 'Unknown';
      const scannedAt = scanDetails?.scanned_at ? new Date(scanDetails.scanned_at).toLocaleString('lo-LA') : 'Unknown';
      
      return NextResponse.json(
        { 
          error: `‚ùå ‡∫õ‡∫µ‡ªâ‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ ${ticketNumber} ‡∫ñ‡∫∑‡∫Å‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡ªÑ‡∫õ‡ªÅ‡∫•‡ªâ‡∫ß`,
          details: {
            message: `‡∫ñ‡∫∑‡∫Å‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡ªÇ‡∫î‡∫ç: ${usedByDriverName} (${usedByEmployeeId})`,
            scannedAt: `‡ªÄ‡∫ß‡∫•‡∫≤: ${scannedAt}`,
            tripId: usedByTrip?._id,
            usedByDriver: {
              name: usedByDriverName,
              employeeId: usedByEmployeeId
            }
          }
        },
        { status: 400 }
      );
    }
    
    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏£‡∏ñ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Group Ticket
    const passengersToAdd = ticket.ticketType === 'group' ? ticket.passengerCount : 1;
    const newTotalPassengers = activeTrip.current_passengers + passengersToAdd;
    
    if (newTotalPassengers > activeTrip.car_capacity) {
      return NextResponse.json(
        { error: `‡∫•‡∫ª‡∫î‡∫à‡∫∞‡ªÄ‡∫ï‡∫±‡∫°! ‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô ${activeTrip.current_passengers} ‡∫Ñ‡∫ª‡∫ô + ${passengersToAdd} ‡∫Ñ‡∫ª‡∫ô = ${newTotalPassengers} ‡∫Ñ‡∫ª‡∫ô (‡∫Ñ‡∫ß‡∫≤‡∫°‡∫à‡∫∏: ${activeTrip.car_capacity} ‡∫Ñ‡∫ª‡∫ô)` },
        { status: 400 }
      );
    }
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Group Ticket)
    const passengerOrder = activeTrip.current_passengers + 1;
    
    activeTrip.scanned_tickets.push({
      ticket_id: ticket._id,
      scanned_at: new Date(),
      passenger_order: passengerOrder
    });
    
    activeTrip.current_passengers = newTotalPassengers;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó is_80_percent_reached
    const is80PercentReached = activeTrip.current_passengers >= activeTrip.required_passengers;
    activeTrip.is_80_percent_reached = is80PercentReached;
    
    await activeTrip.save();
    
    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Group Ticket
    let message = '';
    let statusMessage = '';
    
    if (ticket.ticketType === 'group') {
      message = `‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡∏õ‡∏µ‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: +${passengersToAdd} ‡∫Ñ‡∫ª‡∫ô (‡∏£‡∏ß‡∏° ${activeTrip.current_passengers}/${activeTrip.car_capacity} ‡∫Ñ‡∫ª‡∫ô)`;
    } else {
      message = `‚úÖ ‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î: ${activeTrip.current_passengers}/${activeTrip.car_capacity} ‡∫Ñ‡∫ª‡∫ô`;
    }
    
    if (is80PercentReached && activeTrip.current_passengers < activeTrip.car_capacity) {
      statusMessage = `üéØ ‡∫Ñ‡∫ª‡∫ö‡ªÄ‡∫õ‡∫ª‡ªâ‡∫≤‡ªù‡∫≤‡∫ç ${activeTrip.required_passengers} ‡∫Ñ‡∫ª‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫™‡∫∑‡∫ö‡∫ï‡ªç‡ªà‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫´‡∫º‡∫∑‡∫õ‡∫¥‡∫î‡∫Æ‡∫≠‡∫ö‡ªÑ‡∫î‡ªâ`;
    } else if (activeTrip.current_passengers === activeTrip.car_capacity) {
      statusMessage = `üöå ‡∫•‡∫ª‡∫î‡ªÄ‡∫ï‡∫±‡∫°‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡∫¥‡∫î‡∫Æ‡∫≠‡∫ö`;
    } else {
      const remaining = activeTrip.required_passengers - activeTrip.current_passengers;
      if (remaining > 0) {
        statusMessage = `‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫≠‡∫µ‡∫Å ${remaining} ‡∫Ñ‡∫ª‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡∫ö‡ªÄ‡∫õ‡∫ª‡ªâ‡∫≤‡ªù‡∫≤‡∫ç`;
      }
    }
    
    console.log('Trip updated successfully:', {
      tripId: activeTrip._id,
      currentPassengers: activeTrip.current_passengers,
      requiredPassengers: activeTrip.required_passengers,
      is80PercentReached: is80PercentReached,
      ticketScanned: ticket.ticketNumber,
      ticketType: ticket.ticketType,
      passengersAdded: passengersToAdd
    });
    
    // ‚úÖ Response ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Group Ticket
    return NextResponse.json({
      success: true,
      trip_number: activeTrip.trip_number,
      current_passengers: activeTrip.current_passengers,
      required_passengers: activeTrip.required_passengers,
      car_capacity: activeTrip.car_capacity,
      occupancy_percentage: Math.round((activeTrip.current_passengers / activeTrip.car_capacity) * 100),
      progress_percentage: Math.round((activeTrip.current_passengers / activeTrip.required_passengers) * 100),
      is_80_percent_reached: is80PercentReached,
      can_complete_trip: true,
      trip_completed: false,
      message: message,
      status_message: statusMessage,
      
      // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ticket ‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô
      ticket_info: {
        ticket_id: ticket._id,
        ticket_number: ticket.ticketNumber,
        ticket_type: ticket.ticketType,
        passenger_count: ticket.passengerCount,
        price: ticket.price,
        price_per_person: ticket.pricePerPerson,
        passenger_order: passengerOrder,
        passengers_added: passengersToAdd
      },
      
      // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Group Ticket
      group_ticket_info: ticket.ticketType === 'group' ? {
        is_group_ticket: true,
        total_passengers_in_group: ticket.passengerCount,
        price_breakdown: {
          price_per_person: ticket.pricePerPerson,
          total_group_price: ticket.price,
          calculation: `‚Ç≠${ticket.pricePerPerson.toLocaleString()} √ó ${ticket.passengerCount} = ‚Ç≠${ticket.price.toLocaleString()}`
        }
      } : {
        is_group_ticket: false
      }
    });

  } catch (error) {
    console.error('Scan QR Code Error:', error);
    return NextResponse.json(
      { 
        error: error instanceof Error ? error.message : 'Failed to scan QR code',
        details: error instanceof Error ? error.stack : 'Unknown error occurred'
      },
      { status: 500 }
    );
  }
}